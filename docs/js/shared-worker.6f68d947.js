(function(e){function n(n){for(var r,s,c=n[0],i=n[1],l=n[2],d=0,u=[];d<c.length;d++)s=c[d],Object.prototype.hasOwnProperty.call(a,s)&&a[s]&&u.push(a[s][0]),a[s]=0;for(r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r]);p&&p(n);while(u.length)u.shift()();return o.push.apply(o,l||[]),t()}function t(){for(var e,n=0;n<o.length;n++){for(var t=o[n],r=!0,c=1;c<t.length;c++){var i=t[c];0!==a[i]&&(r=!1)}r&&(o.splice(n--,1),e=s(s.s=t[0]))}return e}var r={},a={"shared-worker":0},o=[];function s(n){if(r[n])return r[n].exports;var t=r[n]={i:n,l:!1,exports:{}};return e[n].call(t.exports,t,t.exports,s),t.l=!0,t.exports}s.m=e,s.c=r,s.d=function(e,n,t){s.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,n){if(1&n&&(e=s(e)),8&n)return e;if(4&n&&"object"===typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(s.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var r in e)s.d(t,r,function(n){return e[n]}.bind(null,r));return t},s.n=function(e){var n=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(n,"a",n),n},s.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},s.p="";var c=window["webpackJsonp"]=window["webpackJsonp"]||[],i=c.push.bind(c);c.push=n,c=c.slice();for(var l=0;l<c.length;l++)n(c[l]);var p=i;o.push([0,"chunk-vendors"]),t()})({0:function(e,n,t){e.exports=t("f8f1")},"0153":function(e,n,t){},"6c3c":function(e,n,t){e.exports=t.p+"img/shared-worker.0608b2c0.png"},"754c":function(e,n,t){e.exports=t.p+"img/loader.04f53a7f.png"},b810:function(e,n,t){e.exports=t.p+"img/inspect.58f596f1.png"},be2b:function(e,n,t){"use strict";var r=t("0153"),a=t.n(r);a.a},f8f1:function(e,n,t){"use strict";t.r(n);t("e260"),t("e6cf"),t("cca6"),t("a79d");var r=t("2b0e"),a=function(){var e=this,n=e.$createElement;e._self._c;return e._m(0)},o=[function(){var e=this,n=e.$createElement,r=e._self._c||n;return r("div",{staticClass:"reveal container"},[r("div",{staticClass:"slides"},[r("section",[e._v("SharedWorker 简介")]),r("section",[r("section",[e._v(" SharedWorker 可以实现同域下，几个窗口、iframe 或其他 worker 共用同一个 worker 线程 "),r("div",{staticStyle:{"margin-top":"10px"}},[r("a",{attrs:{href:"http://mdn.github.io/simple-shared-worker/",target:"_blank"}},[e._v("示例一")]),e._v(" "),r("a",{attrs:{href:"https://ayushgp.github.io/scaling-websockets-using-sharedworkers/",target:"_blank"}},[e._v("示例二")])])]),r("section",[r("p",{staticClass:"container-16"},[e._v(" 有个问题: ")]),r("p",{staticClass:"container-16"},[e._v(" 创建的时候需要指定 shared-worker 脚本的 url ")]),r("p",{staticClass:"container-16"},[e._v(" 本地的 worker 脚本文件经过 webpack 打包后会加上 hash ")]),r("p",{staticClass:"container-16"},[e._v(" 导致我们创建的时候无法指定打包后的脚本 url ")]),r("img",{attrs:{src:t("6c3c")}})]),r("section",[r("p",{staticClass:"container-16"},[e._v(" 解决方案: ")]),r("p",{staticClass:"container-16"},[e._v(" 通过 plugin + loader ")])]),r("section",[r("p",{staticClass:"container-16"},[e._v(" 一个 webpack plugin 由以下几个步骤组成： ")]),r("p",{staticClass:"container-16"},[e._v(" • 一个JavaScript类函数 ")]),r("p",{staticClass:"container-16"},[e._v(" • 在函数原型 (prototype)中定义一个注入compiler对象的apply方法 ")]),r("p",{staticClass:"container-16"},[e._v(" • apply函数中通过compiler插入指定的事件钩子,在钩子回调中拿到compilation对象 ")]),r("p",{staticClass:"container-16"},[e._v(" • 使用compilation操纵修改webapack内部实例数据 ")]),r("p",{staticClass:"container-16"},[e._v(" • 异步插件，数据处理完后使用callback回调 ")])]),r("section",[r("pre",[r("code",{attrs:{"data-trim":"","data-noescape":""}},[e._v("\n            var WorkerPlugin = function WorkerPlugin (options) {\n              ...\n            };\n            WorkerPlugin.prototype.apply = function apply (compiler) {\n              ...\n\t\t\t\t    };\n            module.exports = WorkerPlugin;\n          ")])])]),r("section",[r("p",{staticClass:"container-16"},[e._v(" 一个 loader 在整个 webpack 的 workflow 过程中出现的时机： ")]),r("p",{staticClass:"container-16"},[e._v(" • 初始阶段将用户配置与默认配置合并 ")]),r("p",{staticClass:"container-16"},[e._v(" • 在 webpack 通过 NormalModuleFactory 创建 NormalModule 实例前解析相关配置，比如路径 ")]),r("p",{staticClass:"container-16"},[e._v(" • 将loader处理完的模块内容输出，进入后续的编译流程 ")])]),r("section",[r("img",{staticClass:"container-loader",attrs:{src:t("754c")}})]),r("section",[r("p",{staticClass:"container-16"},[e._v(" 在一个 module 构建过程中，首先根据 module 的依赖类型(例如 "),r("a",{attrs:{href:"https://v4.webpack.js.org/api/parser/",target:"_blank"}},[e._v("NormalModuleFactory")]),e._v(")调用对应的构造函数来创建对应的模块；"),r("br"),e._v(" 在NormalModuleFactory中，创建出NormalModule实例之前会涉及到四个钩子： ")]),r("p",{staticClass:"container-16"},[e._v(" • beforeResolve "),r("br"),e._v(" • resolve "),r("br"),e._v(" • factory "),r("br"),e._v(" • afterResolve ")]),r("p",{staticClass:"container-16"},[e._v(" 其中较为重要的有两个："),r("br"),e._v(" resolve部分负责解析loader模块的路径（例如css-loader这个loader的模块路径是什么）"),r("br"),e._v(" factory负责来基于resolve钩子的返回值来创建NormalModule实例 ")])])]),r("section",[r("pre",[r("code",{attrs:{"data-trim":"","data-noescape":""}},[e._v("\n            // 业务页面\n            if (window.SharedWorker) {\n              const worker = new SharedWorker('./worker', { type: 'module' });\n              worker.port.onmessage = ({ data }) => {\n                ...\n              };\n              worker.port.postMessage('start');\n            }\n            \n            // worker.js\n            // 共用逻辑可以写在 onconnect 外面\n            onconnect = (e) => {\n              const port = e.ports[0];\n              ...\n              port.postMessage(...);\n              port.onmessage = ({ data }) => {\n                ...\n              };\n            }\n            \n            // 插件使用\n            plugins: [\n              new WorkerPlugin({\n                globalObject: 'self'\n              })\n            ]\n          ")])])]),r("section",[r("p",{staticClass:"container-16"},[e._v(" 在worker脚本中，可以通过 onconnect 事件获取页面访问worker的端口port，可以通过port向页面发送消息和监听来自页面的消息。 "),r("br"),r("span",{staticClass:"container-red"},[e._v("在worker脚本中，onconnect函数体外面的内容，在同域中只会执行一次，新开tab也不会再次执行")]),r("br"),r("span",{staticClass:"container-red"},[e._v("onconnect函数体内的内容，每开一个tab，都会执行一次，并且会生成与浏览器tab一一对应的port端口，worker与各个页面的通信，只能通过对应的port端口。")]),r("br"),e._v(" 在worker脚本中是不能访问window对象的，worker有自己的全局对象self。 ")])]),r("section",[r("p",{staticClass:"container-p"},[e._v("调试：")]),r("img",{attrs:{src:t("b810")}})]),r("section",[r("p",{staticClass:"container-16"},[e._v(" 打开 "),r("span",{staticClass:"container-red"},[e._v("chrome://inspect")]),e._v(" 页面，选中shared workers tab，就可以看到当前注册过的shared workers脚本，其中terminate是手动关闭worker脚本，inspect可以唤起调试窗口，和devtools一样，可以在其中进行worker脚本的调试 ")])]),r("section",[r("p",{staticClass:"container-p"},[e._v("关闭：")]),r("p",{staticClass:"container-16"},[e._v(" 当同域下所有的tab页面都关闭了，当前域下注册的worker也会自动销毁，如果需要手动控制，可以在worker脚本中调用 self.close() 来注销当前 worker ")])]),r("section",[r("p",{staticClass:"container-p"},[e._v("BroadcastChannel")]),r("p",{staticClass:"container-16"},[e._v(" worker 可以配合 BroadcastChannel 一起使用，BroadcastChannel 允许同源脚本跨 window / tab、iframe、web worker 进行多对多通信 "),r("br"),e._v(" BroadcastChannel 构造函数只接受参数，就是广播名称（channel name） ")])]),r("section",[r("pre",[r("code",{attrs:{"data-trim":"","data-noescape":""}},[e._v("\n            const channel = new BroadcastChannel('message_xxx');\n            // 发消息\n            channel.postMessage({...});\n            \n            // 接收消息\n            let channel = null;\n            created () {\n              channel = new BroadcastChannel('message_xxx');\n              channel.addEventListener('message', this.handleMessageChannel);\n            },\n            beforeDestroy () {\n              channel.removeEventListener('message', this.handleMessageChannel);\n            },\n            methods: {\n              handleMessageChannel (event) {\n                // 消息内容可以通过 event.data 获取\n              }\n            }\n          ")])])]),r("section",[e._v("Thanks")])])])}],s=t("8785"),c=t("d621"),i=t("3617"),l={name:"SharedWorker",components:{},mounted:function(){var e=new s["a"]({plugins:[c["a"],i["a"]]});e.initialize()}},p=l,d=(t("be2b"),t("2877")),u=Object(d["a"])(p,a,o,!1,null,"090e1c4d",null),v=u.exports;t("d9ac"),t("701e"),t("75e5");r["a"].config.productionTip=!1,new r["a"]({render:function(e){return e(v)}}).$mount("#app")}});